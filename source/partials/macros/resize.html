{% set DEFAULT_QUALITY = 85 %}
{% set AVIF_QUALITY = 63 %}
{% set DEFAULT_BREAKPOINTS = ['xs', 'sm', 'md', 'lg', 'xl'] %}
{% set DEFAULT_SIZES = {xs: 576, sm: 768, md: 992, lg: 1200, xl: 1900} %}

{% macro breakpoints (url, alt, attrs={}, breakpoints=DEFAULT_BREAKPOINTS, sizes=DEFAULT_SIZES, quality=DEFAULT_QUALITY, avif_quality=AVIF_QUALITY) %}
    <picture{% for k, v in attrs %} {{ k }}="{{ v }}"{% endfor %}>
        {% if APP.ENV.PROD or APP.ENV.DEBUG %}
        {% for breakpoint, media in breakpoints_media(breakpoints, sizes) %}
        <source media="{{ media }}" srcset="{{ require(url + '?resize=' + sizes[breakpoint] + 'x&quality=' + avif_quality + '&format=avif&suffix=' + breakpoint) }}" type="image/avif">
        {% endfor %}
        {% for breakpoint, media in breakpoints_media(breakpoints, sizes) %}
        <source media="{{ media }}" srcset="{{ require(url + '?resize=' + sizes[breakpoint] + 'x&quality=' + quality + '&format=webp&suffix=' + breakpoint) }}" type="image/webp">
        {% endfor %}
        {% endif %}

        {% for breakpoint, media in breakpoints_media(breakpoints, sizes) %}
        <source media="{{ media }}" srcset="{{ require(url + '?resize=' + sizes[breakpoint] + 'x&quality=' + quality + '&format=jpg&suffix=' + breakpoint) }}" type="image/jpeg">
        {% endfor %}

        {% set dimensions = image_size(url) %}
        <img 
            src="{{ require(url) }}"
            loading="lazy"
            width="{{ dimensions.width }}"
            height="{{ dimensions.height }}" 
            intrinsicsize="{{ dimensions.width }}x{{ dimensions.height }}"
            alt="{{ alt }}"
        >
    </picture>
{% endmacro %}

{% macro picture (url, alt, attrs={}, quality=DEFAULT_QUALITY, avif_quality=AVIF_QUALITY) %}
    <picture{% for k, v in attrs %} {{ k }}="{{ v }}"{% endfor %}>
        {% if APP.ENV.PROD or APP.ENV.DEBUG %}
        <source srcset="{{ require(url + '?resize=&quality=' + avif_quality + '&format=avif') }}" type="image/avif">
        <source srcset="{{ require(url + '?resize=&quality=' + quality + '&format=webp') }}" type="image/webp">
        {% endif %}

        {% set dimensions = image_size(url) %}
        <img 
            src="{{ require(url) }}"
            loading="lazy"
            width="{{ dimensions.width }}"
            height="{{ dimensions.height }}" 
            intrinsicsize="{{ dimensions.width }}x{{ dimensions.height }}"
            alt="{{ alt }}"
        >
    </picture>
{% endmacro %}
